<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice {{ invoice.invoice_number }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Roboto&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Roboto', sans-serif;
            color: #333;
        }
        .invoice-container {
            max-width: 800px;
            margin: 2rem auto;
            background-color: #fff;
            padding: 2rem;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .invoice-header-logo {
            width: 150px;
            height: auto;
        }
        .invoice-header h1 {
            font-family: 'Playfair Display', serif;
            color: #d63384;
            font-weight: 700;
        }
        .invoice-info, .billing-info {
            font-size: 0.9rem;
        }
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 2rem;
            font-size: 0.9rem;
        }
        .invoice-table th, .invoice-table td {
            border: 1px solid #ddd;
            padding: 1rem;
            text-align: left;
        }
        .invoice-table thead th {
            background-color: #d63384;
            color: white;
            font-weight: bold;
        }
        .invoice-table tfoot td {
            font-weight: bold;
            text-align: right;
        }
        .total-in-words {
            font-style: italic;
            font-size: 0.9rem;
            margin-top: 1rem;
            text-transform: capitalize;
        }
        .invoice-footer-note {
            margin-top: 2rem;
            font-size: 0.9rem;
            color: #666;
            text-align: center;
        }
        @media print {
            body {
                margin: 0;
                padding: 0;
                background-color: #fff;
            }
            .invoice-container {
                box-shadow: none;
                margin: 0;
                padding: 0;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container no-print mt-3">
        <div class="d-flex justify-content-between align-items-center">
            <a href="{{ url_for('manage_invoices') }}" class="btn btn-outline-secondary">← Back to Invoices</a>
            <div>
                <button onclick="window.print()" class="btn btn-info"><i class="bi bi-printer"></i> Print Invoice</button>
                <button onclick="downloadPDF()" class="btn btn-success"><i class="bi bi-download"></i> Download PDF</button>
                <button onclick="shareInvoice()" class="btn btn-primary" id="shareButton">Share as Link</button>
                <button onclick="sharePdf()" class="btn btn-primary" id="sharePdfButton">Share as PDF</button>
            </div>
        </div>
    </div>

    <div class="invoice-container" id="invoiceContainer">
        <div class="row align-items-center mb-4">
            <div class="col-4 text-center">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Mou's Makeup & Nails" class="invoice-header-logo">
            </div>
            <div class="col-8">
                <h1 class="text-end mb-0">INVOICE</h1>
                <p class="text-end mb-0"><strong>INVOICE #:</strong> {{ invoice.invoice_number }}</p>
                <p class="text-end mb-0"><strong>DATE:</strong> {{ invoice.invoice_date.strftime('%d %b %Y') }}</p>
                {% if invoice.due_date %}
                <p class="text-end mb-0"><strong>DUE DATE:</strong> {{ invoice.due_date.strftime('%d %b %Y') }}</p>
                {% endif %}
            </div>
        </div>
        <hr>
        <div class="row mb-4">
            <div class="col-6">
                <p class="billing-info"><strong>TO:</strong></p>
                <h5 class="billing-info">{{ invoice.customer_name }}</h5>
                <p class="billing-info">{{ invoice.customer_address }}</p>
                <p class="billing-info">Phone: {{ invoice.customer_phone or 'N/A' }}</p>
            </div>
            <div class="col-6 text-end">
                <p class="invoice-info"><strong>FROM:</strong></p>
                <h5 class="invoice-info">Mou's Makeup & Nails</h5>
                <p class="invoice-info">226/M, Jayrampur Jala Road, BG Press Market, Kolkata</p>
                <p class="invoice-info">Phone: 9330482697 | deymoupriya12@gmail.com</p>
            </div>
        </div>

        <table class="invoice-table">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Advance</th>
                    <th>Due</th>
                </tr>
            </thead>

    <tbody>
        {% for service in services %}
            <tr>
                <td>{{ service.description }}</td>
                <td>₹{{ "{:,.2f}".format(service.amount) }}</td>
                <td></td>
                <td></td>
            </tr>
        {% endfor %}
    </tbody>

            <tfoot>
                <tr>
                    <td colspan="2" class="text-end"><strong>Advance Paid:</strong></td>
                    <td colspan="2">₹{{ "{:,.2f}".format(invoice.advance_amount) }}</td>
                </tr>
                <tr>
                    <td colspan="2" class="text-end"><strong>Due Amount:</strong></td>
                    <td colspan="2">₹{{ "{:,.2f}".format(invoice.due_amount) }}</td>
                </tr>
                <tr>
                    <td colspan="2" class="text-end"><strong>Total Amount:</strong></td>
                    <td colspan="2">₹{{ "{:,.2f}".format(invoice.total_amount) }}</td>
                </tr>
            </tfoot>
        </table>

        <div class="text-end mt-3">
            <p class="total-in-words">Amount in words: {{ number_to_words(invoice.total_amount) }} Only</p>
        </div>

        <hr>
        <div class="invoice-footer-note">
            <p>Thank you for your business!</p>
            <p>Visit us at <a href="https://makeup-booking.onrender.com/">https://makeup-booking.onrender.com/</a></p>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function numberToWords(n) {
            const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
            const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];

            const inWords = (num) => {
                let str = '';
                if (num < 20) str = a[num];
                else str = b[Math.floor(num / 10)] + (num % 10 !== 0 ? ' ' + a[num % 10] : '');
                return str;
            };

            const parse = (num) => {
                if (num === 0) return '';
                let str = '';
                if (num >= 10000000) {
                    str += inWords(Math.floor(num / 10000000)) + 'crore ';
                    num %= 10000000;
                }
                if (num >= 100000) {
                    str += inWords(Math.floor(num / 100000)) + 'lakh ';
                    num %= 100000;
                }
                if (num >= 1000) {
                    str += inWords(Math.floor(num / 1000)) + 'thousand ';
                    num %= 1000;
                }
                if (num >= 100) {
                    str += inWords(Math.floor(num / 100)) + 'hundred ';
                    num %= 100;
                }
                if (num > 0) {
                    if (str !== '') str += 'and ';
                    str += inWords(num);
                }
                return str;
            };

            const [intPart, decPart] = String(n.toFixed(2)).split('.');
            let words = parse(parseInt(intPart));
            if (parseInt(decPart) > 0) {
                words += `and ${inWords(parseInt(decPart))} paise`;
            }

            return words.trim().replace(/\s+/g, ' ');
        }

        // PDF Generation function (now returns a Blob)
        async function getPdfBlob() {
            const invoiceElement = document.querySelector('.invoice-container');
            const canvas = await html2canvas(invoiceElement, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            return new Blob([pdf.output('arraybuffer')], { type: 'application/pdf' });
        }

        // PDF Download Logic
        async function downloadPDF() {
            const pdfBlob = await getPdfBlob();
            const url = URL.createObjectURL(pdfBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `invoice-{{ invoice.invoice_number }}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Web Share API for sharing link
        const shareButton = document.getElementById('shareButton');
        const sharePdfButton = document.getElementById('sharePdfButton');

        if (navigator.share) {
            shareButton.style.display = 'inline-block';
            shareButton.classList.add('btn-primary');
        } else {
            shareButton.style.display = 'none'; // Hide if not supported
        }

        async function shareInvoice() {
            const invoiceNumber = "{{ invoice.invoice_number }}";
            const shareData = {
                title: `Invoice ${invoiceNumber}`,
                text: `Here is the invoice for {{ invoice.customer_name }}`,
                url: 'https://makeup-booking.onrender.com' + window.location.pathname,
            };

            try {
                await navigator.share(shareData);
                console.log('Invoice shared successfully');
            } catch (err) {
                console.error('Error sharing invoice:', err);
            }
        }

        // New Web Share API for sharing PDF
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([], 'invoice.pdf', { type: 'application/pdf' })] })) {
            sharePdfButton.style.display = 'inline-block';
            sharePdfButton.classList.add('btn-primary');
        } else {
            sharePdfButton.style.display = 'none'; // Hide if not supported
        }

        async function sharePdf() {
            try {
                const pdfBlob = await getPdfBlob();
                const invoiceNumber = "{{ invoice.invoice_number }}";
                const file = new File([pdfBlob], `invoice-${invoiceNumber}.pdf`, { type: 'application/pdf' });

                const shareData = {
                    files: [file],
                    title: `Invoice ${invoiceNumber}`,
                    text: `Here is the invoice for {{ invoice.customer_name }}.`
                };
                
                await navigator.share(shareData);
            } catch (err) {
                console.error('Error sharing PDF:', err);
                alert('An error occurred while sharing the PDF. Please try downloading it instead.');
            }
        }
    </script>
</body>
</html>